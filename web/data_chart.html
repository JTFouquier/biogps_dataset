<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-- saved from url=(0061)http://plugins.biogps.org/data_chart/data_chart.cgi?id=362817 -->
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US" xml:lang="en-US" class="  ext-strict">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
        <title>Data Chart Plugin</title>
        <link rel="icon" type="image/vnd.microsoft.icon" href="http://compdisc.gnf.org/hts/hts.ico">

        <!-- <link rel="stylesheet" type="text/css" href="./css/ext-all.css"> -->
        <link rel="stylesheet" type="text/css" href="./css/flexigrid.css"/>
        <!-- <script src="./js/ext_mainApp.js" type="text/JavaScript"></script> -->
        <script src="./js/jquery_custom.js" type="text/JavaScript"></script>
        <!--<script src="./js/jquery.ui.core.js" type="text/JavaScript"></script>-->
        <!--<script src="./js/jquery.ui.widget.js" type="text/JavaScript"></script>-->
        <!--<script src="./js/jquery.ui.accordion.js" type="text/JavaScript"></script>-->
        <script src="./js/jquery-ui.js" type="text/JavaScript"></script>
        <script type="text/javascript" src="./js/flexigrid.js"></script>

        <style id="clearly_highlighting_css" type="text/css">
/* selection */ html.clearly_highlighting_enabled ::-moz-selection { background: rgba(246, 238, 150, 0.99); } html.clearly_highlighting_enabled ::selection { background: rgba(246, 238, 150, 0.99); } /* cursor */ html.clearly_highlighting_enabled {    /* cursor and hot-spot position -- requires a default cursor, after the URL one */    cursor: url("chrome-extension://pioclpoplcdbaefihamjohnefbikjilc/clearly/images/highlight--cursor.png") 14 16, text; } /* highlight tag */ em.clearly_highlight_element {    font-style: inherit !important; font-weight: inherit !important;    background-image: url("chrome-extension://pioclpoplcdbaefihamjohnefbikjilc/clearly/images/highlight--yellow.png");    background-repeat: repeat-x; background-position: top left; background-size: 100% 100%; } /* the delete-buttons are positioned relative to this */ em.clearly_highlight_element.clearly_highlight_first { position: relative; } /* delete buttons */ em.clearly_highlight_element a.clearly_highlight_delete_element {    display: none; cursor: pointer;    padding: 0; margin: 0; line-height: 0;    position: absolute; width: 34px; height: 34px; left: -17px; top: -17px;    background-image: url("chrome-extension://pioclpoplcdbaefihamjohnefbikjilc/clearly/images/highlight--delete-sprite.png"); background-repeat: no-repeat; background-position: 0px 0px; } em.clearly_highlight_element a.clearly_highlight_delete_element:hover { background-position: -34px 0px; } /* retina */ @media (min--moz-device-pixel-ratio: 2), (-webkit-min-device-pixel-ratio: 2), (min-device-pixel-ratio: 2) {    em.clearly_highlight_element { background-image: url("chrome-extension://pioclpoplcdbaefihamjohnefbikjilc/clearly/images/highlight--yellow@2x.png"); }    em.clearly_highlight_element a.clearly_highlight_delete_element { background-image: url("chrome-extension://pioclpoplcdbaefihamjohnefbikjilc/clearly/images/highlight--delete-sprite@2x.png"); background-size: 68px 34px; } }
        </style>
        <link type="text/css" rel="stylesheet" href="./css/jquery-ui-1.8.5.custom.css">
        <link rel="stylesheet" type="text/css" href="./css/data_chart.css">
        <style>
            [touch-action="none"] {
                -ms-touch-action: none;
                touch-action: none;
            }
            [touch-action="pan-x"] {
                -ms-touch-action: pan-x;
                touch-action: pan-x;
            }
            [touch-action="pan-y"] {
                -ms-touch-action: pan-y;
                touch-action: pan-y;
            }
            [touch-action="scroll"], [touch-action="pan-x pan-y"], [touch-action="pan-y pan-x"] {
                -ms-touch-action: pan-x pan-y;
                touch-action: pan-x pan-y;
            }
        </style>

        <!-- <script language="JavaScript" src="./js/PagingStore_Ext.js"></script> -->
        <script language="JavaScript">
            DC_026887848 = {
                dsCanvas : false,
                dsID : -1,
                geneID : -1,
                dsName : "",
                dsPage : 1,
                dsPages : 1,
                dsSearchTerm : "",
                dsSummary : "",
                mygeneReps : "NM_199501,XM_006240778,XR_355212,1378874_at,1394320_at,D28753_i_at,D28754_s_at,362817",
                sortFactor : "",
                tabContentContainerIDs : ["DC_026887848_dataset_canvas", "DC_026887848_probe_set_image", "DC_026887848_correlationContainer", "DC_026887848_downloadContainer"],
                facet : null,
                group : false,
                chart_label : null,
                fresh_timer : null,
                init : function() {
                    this.loadTabs();
                    this.showCanvasControls();
                    this.initSlider();
                    this.initCanvas();
                    this.loadDataset("");
                    this.checkDatasetImageSize();
                },

                showCanvasControls : function() {
                    if (DC_026887848.dsCanvas == true) {
                        $("#DC_026887848_canvas_clear_button").show();
                        $("#DC_026887848_canvas_save_button").show();
                        $("#DC_026887848_canvas_search_controls").show();
                        $("#DC_026887848_canvas_zoom_label").show();
                        // $("#DC_026887848_canvas_graph_type_wrapper").show();
                    }
                },

                probeData : null,

                sliderResolution : 1000,
                initSlider : function() {
                    if (DC_026887848.dsCanvas == true) {
                        $("#DC_026887848_canvas_chart_slider").slider({
                            range : true,
                            min : 0,
                            max : DC_026887848.sliderResolution,
                            values : [0, DC_026887848.sliderResolution],
                            slide : function(event, ui) {

                                DC_026887848.updateCanvasGraph();
                            },
                            stop : function(event, ui) {

                                DC_026887848.updateCanvasGraph();
                            }
                        });
                    }
                },

                setRawLink : function() {
                    var probeBox = document.getElementById("DC_026887848_probe");
                    var ps = probeBox[0].value;
                    for (var i = 1; i < probeBox.length; i++) {
                        ps = ps + "," + probeBox[i].value;
                    }

                    var rawLink = document.getElementById("DC_026887848_Download_link");
                    var url = "/dataset/csv/"+this.dsID+"/gene/"+this.geneID+"/";
                    rawLink.href = url;
                    rawLink.innerHTML = "Get raw data for " + this.dsName;
                },

                setProbeImage : function() {
                    //var url_base = "http://biogps.org/dataset/";
                    var probes = document.getElementById("DC_026887848_probe");
                    var pval = "NA";

                    for ( i = 0; i < probes.length; i++) {
                        if (probes.options[i].selected) {
                            pval = probes.options[i].text;
                            break;
                        }
                    }
                    var datarowname = "" + pval;
                    var datasetid = "" + this.dsID;

                    var url = '/dataset/chart/'+datasetid+'/reporter/' + datarowname+'/';
                    if(this.facet!= null)
                    {
                        url += ('?group='+this.facet);
                        if(this.group)
                        {
                            url += '&collapse=on';
                        }
                        else
                        {
                            url += '&name='+this.facet;
                        }
                    }
                    var w = document.body.clientWidth - 80;
                    if (w>1200) w=1200;
                    $('#DC_026887848_probe_set_image').width(w);
                    document.images["DC_026887848_probe_set_image"].src = url;
                },

                setProbe : function() {
                    this.setProbeImage();
                    this.updateCanvasGraph();
                },

                setDatasetCookie : function() {
                    // Check for last-viewed dataset, otherwise use default
                    var org_cookie_name = "org_10116";
                    var ds = "5";
                    if (this.dsID != -1) {
                        ds = this.dsID;
                    }
                    document.cookie = org_cookie_name + "=" + encodeURIComponent(ds) + "; max-age=" + (60 * 60 * 12);
                },

                handleNoData : function() {
                    // Update canvas, etc when no data found
                    var _msg = "No data for current gene in the \"" + DC_026887848.dsName + "\" data set.";
                    var _htmlMsg = "<p class=\"ds-error\">" + _msg + "</p>";

                    var containers = DC_026887848.tabContentContainerIDs;
                    for (var i = 0; i < containers.length; i++) {
                        var _content = $("#" + containers[i]);
                        _content.before(_htmlMsg);
                        _content.hide();
                    }

                    // Determine position for dataset dialog
                    var pos = $("#datachartVer").offset();

                    _dialog.dialog({
                        draggable : true,
                        modal : false,
                        position : [pos.left + 5, pos.top + 15],
                        resizable : true,
                        title : "Datasets with data for current gene",
                        width : $("#DC_026887848_tabs1").width() * 0.7,
                        open : this.getDatasets()
                    });
                },
                //get non-default ds
                getDatasetsNonDefault: function(){
                    var _dsLibUrl = "/dataset/search/?gene="+DC_026887848.geneID+"&page=" + DC_026887848.dsPage;
                    if (DC_026887848.dsSearchTerm !== "") {
                        _qTerm =    DC_026887848.dsSearchTerm;
                        _dsLibUrl += '&query='+_qTerm;
                    }
                    $.getJSON(_dsLibUrl, function(allDatasets, code) {
                        if (code != "success") {
                            // Error getting json from server
                            DCCG.buildCanvasError(DC_026887848.getCanvas());
                        } else {
                            DC_026887848.updateDialog(allDatasets.details, null);
                        }
                    });
                },
                //get both default and non-default ds
                getDatasets : function() {
                    // Query SL for relevant datasets, encoding url for use with proxy
                    var _dsLibUrl = "/dataset/search/all/?gene="+DC_026887848.geneID;
                    if (DC_026887848.dsSearchTerm !== "") {
                        _dsLibUrl += '&query='+DC_026887848.dsSearchTerm;
                    }

                    // All datasets
                    $.getJSON(_dsLibUrl, function(res, code) {
                        if (code != "success") {
                            // Error getting json from server
                            DCCG.buildCanvasError(DC_026887848.getCanvas());
                        } else {
                            DC_026887848.updateDialog(res.details['non-default'], res.details['default']);
                        }
                    });
                },

                changeSearchTerm : function(event, qTerm) {
                    // Update search term used to query datasets
                    if (event.keyCode == 13) {
                        // Enter button pressed
                        DC_026887848.dsPage = 1;
                        DC_026887848.dsSearchTerm = qTerm.replace(/ /g, "+");
                        DC_026887848.getDatasets();
                    }
                },
                updateFactorDialog : function(){

                },

                updateDialog : function(allDatasets, defaultDatasets) {
                    // Set datset info/pages for all datasets,
                    $("#dsLibTotal").html(allDatasets.count);
                    $("#dsLibPageNum").html(DC_026887848.dsPage);
                    var _numPages = allDatasets.total_page;
                    DC_026887848.dsPages = _numPages;
                    $("#dsLibPages").html(_numPages);

                    // Append datasets to list
                    var _titleWidth = 100;
                    $("#dsList").empty();
                    $.each(allDatasets.results, function(idx, ds) {
                        var _dsClass = (idx % 2 == 0 ? "odd-li" : "even-li");
                        var _dsTitle = (ds.name.length > _titleWidth ? ds.name.substring(0, _titleWidth - 3) + "..." : ds.name);
                        _dsTitle += "  (" + ds.sample_count + " samples)";
                        $("#dsList").append('<a class="ds-dialog" href="javascript:void(0)" onclick="DC_026887848.loadDataset(\'' + ds.geo_gse_id + '\')"><li class="ds-dialog ' + _dsClass + '" id="ds' + ds.id + '">' + _dsTitle + '</li></a>');
                    });
                    // Update default datasets
                    if(defaultDatasets)
                    {
                        $("#dsDefaultsList").empty();
                        $("#dsDefaultTotal").html(defaultDatasets.count);
                        $.each(defaultDatasets.results, function(idx, ds) {
                            var _dsClass = (idx % 2 == 0 ? "odd-li" : "even-li");
                            var _dsTitle = (ds.name.length > _titleWidth ? ds.name.substring(0, _titleWidth - 3) + "..." : ds.name);
                            _dsTitle += "  (" + ds.sample_count + " samples)";
                            $("#dsDefaultsList").append('<a class="ds-dialog" href="javascript:void(0)" onclick="DC_026887848.loadDataset(\'' + ds.geo_gse_id + '\')"><li class="ds-dialog ' + _dsClass + '" id="ds' + ds.id + '">' + _dsTitle + '</li></a>');
                        });
                    }
                },

                updateSummary : function(mode) {
                    // Show/hide long dataset summaries
                    var _summary = DC_026887848.dsSummary;
                    if (_summary.length > 100) {
                        if (mode == "less") {
                            _summary = _summary.substr(0, 100) + "...";
                        }
                        $("#datasetSummaryMoreLink").show();
                    } else {
                        $("#datasetSummaryMoreLink").hide();
                    }
                    $("#datasetSummary").html(_summary);

                    // Switch mode for output
                    mode = (mode === "less") ? "more" : "less";

                    // Remove original onClick, bind new, update link text
                    $("#datasetSummaryMoreLink").attr("onclick", "").click(function() {
                        DC_026887848.updateSummary(mode);
                    }).text(mode);
                },

                changeDSPage : function(dir) {
                    // Confirm more than one page of results
                    if (DC_026887848.dsPages !== 1) {
                        // Change page number for SL call
                        if (dir === "+" && DC_026887848.dsPage != DC_026887848.dsPages) {
                            DC_026887848.dsPage += 1;
                        } else if (dir === "-" && DC_026887848.dsPage > 1) {
                            DC_026887848.dsPage -= 1;
                        } else {
                            DC_026887848.dsPage = 1;
                        }
                        this.getDatasetsNonDefault();
                    }
                },

                resetDSLib : function() {
                    $('#searchDS').val('');
                    DC_026887848.dsSearchTerm = "";
                    DC_026887848.dsPage = 1;
                    DC_026887848.getDatasets();
                },

                changeDataset : function() {
                    _dialog.dialog({
                        draggable : false,
                        modal : true,
                        position : "top",
                        resizable : true,
                        title : "Select a dataset",
                        width : $("#DC_026887848_tabs1").width() * 0.7,
                        open : this.getDatasets()
                    });

                    // Add search bar to dialog
                    $("#accordion").before(searchBar);
                },
                showFactors: function(){

                    var fd = _factor_dialog.dialog({
                        draggable : false,
                        modal : true,
                        position : "top",
                        resizable : true,
                        title : "All Factors",
                        width : $("#DC_026887848_tabs1").width() * 0.6,
                        buttons:{
                            Reset:function(){
                                DC_026887848.changeFacet(this, true);
                                DC_026887848._clear_factor_radio();
                                $(this).dialog("close");
                            },
                            Apply:function(){
                                DC_026887848.changeFacet(this);
                                $(this).dialog("close");
                            }
                         }
                        //open : this.updateFactorDialog()
                    });
                    $('.ui-dialog-buttonpane').css('text-align', 'center');
                },
                clearCorrData : function() {
                    if (this.Corr_Store !== null) {
                        this.Corr_Store.removeAll();
                    }
                },

                //
                //START CANVAS ROUTINES
                //
                //
                //
                saveCanvas : function() {
                    if (DC_026887848.dsCanvas == true) {
                        DCCG.saveCanvas(this.getCanvas());
                    }
                },

                getCanvas : function() {
                    if (DC_026887848.dsCanvas == true) {
                        var can = document.getElementById("DC_026887848_canvas_chart");
                        if (can != null) {
                            return can.getContext("2d");
                        } else {
                            return null;
                        }
                    }
                },

                resizeCanvas : function() {
                    var chart_container_width = $("#DC_026887848_outside").width();
                    // Ext JS will ignore TabPanel margin setting unless we also use
                    // BorderLayout or a BoxLayout subclass... Simply subtracting
                    // margin value here instead
//                    Ext.getCmp("dataChartTabPanel").setWidth(chart_container_width - 10);
                    $('#dataChartTabPanel').width(chart_container_width - 10);
                    if (DC_026887848.dsCanvas == true) {
                        DCCG.clearCanvas(this.getCanvas());
                        this.updateCanvasGraph();
                    }
                },

                initCanvas : function() {
                    // Chart container width on initialization is +15px for some odd
                    // reason... Ext JS?
                    var chart_container_width = $("#DC_026887848_outside").width() - 15;
                    $('#dataChartTabPanel').width(chart_container_width - 10);
//                    Ext.getCmp("dataChartTabPanel").setWidth(chart_container_width - 10);
                    if (DC_026887848.dsCanvas == true) {
                        DCCG.clearCanvas(this.getCanvas());
                        DCCG.buildCanvasLoading(this.getCanvas());
                    }
                },

                //holds positional data for the canvas interactive areas.
                canvasMap : null,
                setCanvasMouseMap : function(map) {
                    if (DC_026887848.dsCanvas == true) {
                        //unbind previous events, just in case.
                        $("#DC_026887848_canvas_chart").unbind("mousemove");
                        $("#DC_026887848_canvas_chart").unbind("click");

                        if (map == null) {//A null map indicates that we want to clear the map.
                            this.canvasMap = null;
                            return;
                        } else {
                            //We want to store the mouse map for the canvas, we also want to bind a few events..
                            this.canvasMap = map;

                            //Bind the mousemove event so we can respond to mouse movement.
                            $("#DC_026887848_canvas_chart").mousemove(function(event) {
                                if (DC_026887848.canvasMap == null) {
                                    //We dont want this event to fire when we have a null map, so get rid of it.
                                    $("#DC_026887848_canvas_chart").unbind("mousemove");

                                    return false;
                                };
                                //We only get the coordinates relative to the document, so we change them to relative to the canvas.
                                var offset = $("#DC_026887848_canvas_chart").offset();
                                DC_026887848.canvasMouseMove(event.pageX - offset.left, event.pageY - offset.top);
                            });
                            //Bind the mouse click event so we can respond to mouse clicks.
                            $("#DC_026887848_canvas_chart").click(function(event) {
                                if (DC_026887848.canvasMap == null) {
                                    //We dont want this event to fire when we have a null map, so get rid of it.
                                    $("#DC_026887848_canvas_chart").unbind("click");

                                    return false;
                                };
                                //We only get the coordinates relative to the document, so we change them to relative to the canvas.
                                var offset = $("#DC_026887848_canvas_chart").offset();
                                DC_026887848.canvasMouseClick(event.pageX - offset.left, event.pageY - offset.top);
                            });
                        }
                        return;
                    }
                },

                //used to cause the canvas to redraw if there is a hover/mouseover event..
                currentMouseOver : null,
                canvasMouseMove : function(x, y) {
                    if (DC_026887848.dsCanvas == true) {
                        if (this.canvasMap == null) {
                            return false;
                        };
                        var cmo = this.currentMouseOver;
                        var canvasMap = this.canvasMap;

                        var clear = true;
                        for (var i = 0; i < canvasMap.length; i++) {
                            if (y >= canvasMap[i].yStart && y < canvasMap[i].yEnd) {
                                var dNum = canvasMap[i].dataNum;

                                if (dNum == cmo) {
                                    return true;
                                    // No change, do nothing
                                } else {
                                    // Mouse over different sample, update everything
                                    if (this.graph_type == "bar" || this.graph_type == "plot") {
                                        var singleData = null;
                                        var ps = this.getCurrentProbeSet();
                                        singleData = this.probeData[ps];
                                        if (singleData == null) {
                                            return false;
                                        }

                                        // Remove Mouseover from previous sample
                                        if (cmo != null && cmo >= 0 && singleData[cmo]) {
                                            singleData[cmo].Mouseover = false;
                                        }

                                        // Update current sample with Mouseover
                                        if (dNum != null && dNum >= 0 && singleData[dNum]) {
                                            singleData[dNum].Mouseover = true;
                                            this.updateCanvasGraph();
                                        }
                                    }//end bar graph.
                                    this.currentMouseOver = dNum;
                                }
                                clear = false;
                                break;
                            }
                        }

                        if (clear == true) {
                            if (this.graph_type == "bar" || this.graph_type == "plot") {
                                var singleData = null;
                                var ps = this.getCurrentProbeSet();
                                singleData = this.probeData[ps];
                                if (singleData == null) {
                                    return false;
                                }

                                if (cmo != null && cmo >= 0 && singleData[cmo]) {
                                    singleData[cmo].Mouseover = false;
                                    this.updateCanvasGraph();
                                }
                            }//end bar graph.
                            this.currentMouseOver = null;
                        }
                        return true;
                    }
                },

                // Redraw canvas after a click event
                canvasMouseClick : function(x, y) {
                    if (DC_026887848.dsCanvas == true) {
                        if (this.canvasMap == null || this.probeData == null) {
                            return false;
                        };

                        var canvasMap = this.canvasMap;
                        var singleData = null;
                        var ps = this.getCurrentProbeSet();
                        singleData = this.probeData[ps];

                        if (this.graph_type == "bar" || this.graph_type == "plot") {
                            if (singleData == null) {
                                return false;
                            }

                            for (var i = 0; i < canvasMap.length; i++) {
                                if (y >= canvasMap[i].yStart && y < canvasMap[i].yEnd) {
                                    var dNum = canvasMap[i].dataNum;
                                    if (dNum != null && dNum >= 0 && dNum < singleData.length) {
                                        if (singleData[dNum].Selected == null || singleData[dNum].Selected < 0) {
                                            singleData[dNum].Selected = x;
                                            //store the location of the click.
                                        } else {
                                            singleData[dNum].Selected = -1;
                                        }
                                        this.updateCanvasGraph();
                                    }
                                    break;
                                }
                            }
                        } else {
                            return false;
                        }

                        return true;
                    }
                },

                //used to remove all labels on the canvas (caused by clicking).
                clearCanvasLabels : function() {
                    if (DC_026887848.dsCanvas == true) {
                        if (this.probeData == null) {
                            return false;
                        };

                        var canvasMap = this.canvasMap;
                        var singleData = null;
                        var ps = this.getCurrentProbeSet();
                        singleData = this.probeData[ps];

                        if (this.graph_type == "bar" || this.graph_type == "plot") {
                            if (singleData == null) {
                                return false;
                            }

                            for (var i = 0; i < singleData.length; i++) {
                                singleData[i].Selected = -1;

                            }
                            this.updateCanvasGraph();

                        } else {
                            return false;
                        }
                        return true;
                    }
                },

                getProbeData : function() {
                    // Make two queries to SL - one for dataset metadata (factors),
                    // one for dataset values (probeset_list)
                    if (DC_026887848.dsCanvas == true) {
                        this.initCanvas();
                    };
                    var ds = this.dsID;
                    if (ds == -1) {
                        alert("Error: No dataset selected");
                        return false;
                    }

                    $.ajaxSetup({
                        "error" : function() {
                            DCCG.buildCanvasError(DC_026887848.getCanvas());
                        },
                        "beforeSend" : function(xhr) {
                            xhr.setRequestHeader("accept", "application/json");

                        }
                    });

                    // Dataset factors
                    var mygeneReps = this.mygeneReps;
                    var gene = this.geneID;
                    $("#datasetName a").attr('href', "/dataset/meta/"+ds+"/");
                    var url = "/dataset/full-data/"+ds+"/gene/"+gene+"/";
                    if(this.facet != null){
                        url += ("?group="+this.facet);
                        if(this.group)
                        {
                            url += '&collapse=on';
                        }
                    }

                    if(this.chart_label!=null){
                        if(this.facet != null)
                            url += '&name='+this.chart_label;
                        else
                            url += '?name='+this.chart_label;
                    }
                    $.getJSON(url, function(dataJson, code) {
                        if (code != "success") {
                            // Error getting json from server
                            DCCG.buildCanvasError(DC_026887848.getCanvas());
                        } else {
                            if (dataJson.code != 0)
                                 DCCG.buildCanvasError(DC_026887848.getCanvas());
                            if(dataJson.details.owner=='arrayexpress_sid')
                            {
                                $("#go-ae a").attr('href', "http://www.ebi.ac.uk/arrayexpress/experiments/"+dataJson.details.geo_gse_id+"/");
                                $("#go-ae").show();
                            }
                            DC_026887848.setProbeData(dataJson.details);
                        }
                    });
                },

                clearProbeData : function() {
                    // Eradicate any data that we might be holding on probes.
                    // Clear out previous dataset probes
                    var probeBox = document.getElementById("DC_026887848_probe");
                    while (probeBox.length > 0) {
                        probeBox.remove(0);
                    }
                    this.probeData = null;
                    this.setCanvasMouseMap(null);
                    this.clearFacet();
                    this.clearLabel();
                },

                /* setProbeData -- Call this after downloading json data for new group of probesets. It will
                 * condition the data and perform minor stat analysis.
                 */
                setProbeData : function(dataJson) {
                    // Populate dataset metadata fields in plugin
                    var dsMetadata = dataJson;
                    var probeList = dataJson.faceted_values;
                    var dsName = dsMetadata["name"];
                    DC_026887848.dsName = dsName;
                    $("#datasetName a").text(dsName);

                    if (dsMetadata["summary"]) {
                        DC_026887848.dsSummary = dsMetadata["summary"];
                        DC_026887848.updateSummary("less");
                        $("#datasetSummaryContainer").show();
                    } else {
                        DC_026887848.dsSummary = "";
                        // Clear any pre-existing description
                        $("#datasetSummary").html("");
                        $("#datasetSummaryContainer").hide();
                    }

                    if (dsMetadata["source"]) {
                        $("#datasetSource").html(dsMetadata["source"]);
                        $("#datasetSourceContainer").show();
                    } else {
                        // Clear any pre-existing source
                        $("#datasetSource").html("");
                        $("#datasetSourceContainer").hide();
                    }

                    if(Object.keys(probeList).length==0)
                    {
                        DC_026887848.handleNoData();
                        return;
                    }else {
                        // In case previous dataset/gene combo had no data, clean up/reset
                        $(".ds-error").remove();
                        var containers = DC_026887848.tabContentContainerIDs;
                        for (var i = 0; i < containers.length; i++) {
                            var _content = $("#" + containers[i]);
                            _content.show();
                        }
                    }

                    this.probeData = {};
                    var probeBox = document.getElementById("DC_026887848_probe");
                    var refresh_rep = false;
                    if(probeBox.options.length==0) refresh_rep = true;
                    var ctx = this.getCanvas();
                    for(var e in probeList)
                    {
                        var v = probeList[e];
                        this.probeData[e] = [];
                        var max_with_err=min_with_err=max_val=min_val=max_txt_len=0;
                        for(var j=0; j<v.length; j++)
                        {
                            var item = v[j];
                            this.probeData[e].push({'Mark':false, 'color_idx':item.color_idx,
                                'column_name':item.name, 'mean':item.value, 'value':item.value,
                                'order_idx':item.order_idx, 'stderr':item.dev, 'title':item.name});
                            //max and min value in array
                            if(item.value>max_val) max_val=item.value;
                            if(item.value<min_val) min_val=item.value;
                            //max and min value (with regard to err value)
                            var f_v;
                            if(item.value>0) f_v = item.value+item.dev;
                            if(item.value<0) f_v = item.value-item.dev;
                            if(f_v>max_with_err) max_with_err = f_v;
                            if(f_v<min_with_err) min_with_err = f_v;
                            // Calculate maximum text length
                            var txt_len = (ctx == null ? item.name.length : DCCG.textLen(ctx, item.name));
                            if (txt_len > max_txt_len) {
                                max_txt_len = txt_len;
                            };
                        }

                        //calculate median
                        var ln = probeList[e].length;
                        if(ln>0)
                        {
                            var median;
                            probeList[e].sort(function(a,b){return a.value>b.value?1:-1;});

                            if(ln%2 == 0)
                            {
                                median = (probeList[e][ln/2].value+probeList[e][ln/2-1].value)/2;
                            }
                            else
                            {
                                median = probeList[e][Math.floor(ln/2)].value;
                            }
                            this.probeData[e].Median = median;
                        }

                        this.probeData[e].sort(function(a, b) {
                            return a['order_idx'] - b['order_idx'];
                        });
                        this.probeData[e].maxTxtLen = max_txt_len;
                        this.probeData[e].maxVal = max_val;
                        this.probeData[e].minVal = min_val;

                        if (max_with_err <= 0) {
                            max_with_err = 1;
                        } else {
                            var tmp = Math.pow(10, Math.floor(Math.log(max_with_err) / Math.log(10)));
                            max_with_err = (Math.floor(max_with_err / tmp) + 1) * tmp;
                        }
                        if (min_with_err >= 0) {
                            min_with_err = 0;
                        } else {
                            min_with_err = min_with_err * -1;
                            var tmp = Math.pow(10, Math.floor(Math.log(min_with_err) / Math.log(10)));
                            min_with_err = (Math.floor(min_with_err / tmp) + 1) * tmp;
                            min_with_err = min_with_err * -1;
                        }

                        this.probeData[e].roundedMaxVal = max_with_err;
                        this.probeData[e].roundedMinVal = min_with_err;
                        this.probeData[e].zoomMaxVal = max_with_err;
                        this.probeData[e].zoomMinVal = min_with_err;
                        this.probeData[e].id = e;

                        if(refresh_rep){
                            //init reporter drop down
                            var o = document.createElement("option");
                            o.text = e;
                            try {
                                probeBox.add(o,null); // standards compliant
                            }
                            catch(ex){
                                probeBox.add(o); // IE only
                            }
                            probeBox.options[0].selected = true;
                        }
                    }

                    if (ctx != null) {
                        this.searchGraph(true);
                    }
                    //static image
                    this.setProbeImage();
                    this.setRawLink();
                },

                searchTxt : null, //We only want to do a search when this one changes.

                searchGraph : function(override) {
                    //This is the parent function to searching the probe data.
                    //First thing we need to validate our input.
                    var txt = this.getSearchTerm();
                    txt = txt.replace(/^\s+/, "");
                    txt = txt.replace(/\s+$/, "");

                    if (/^\s*$/.test(txt)) {
                        txt = null;
                    }
                    if (txt != this.searchTxt || override != null) {
                        this.searchTxt = txt;
                        this.searchProbeData(txt);
                        this.updateCanvasGraph();
                    }
                },

                getSearchTerm : function() {
                    //A quick way to get the term that was searched for.
                    var txt = $("#DC_026887848_canvas_search").val();
                    return txt;
                },

                searchProbeData : function(txt) {
                    //Allows us to set a highlight flag on samples if the name matches the search terms.
                    //we set a special flag call .Mark to either true or false (true indicates a match that should be highlighted).

                    var allData = this.probeData;
                    if (allData == null) {
                        return false;
                    }

                    if (txt == null) {
                        //Dont have a search term, so loop through all the data and clear all the highlight/mark flags.

                        for (var p in allData) {
                            var sampData = allData[p];
                            for (var s in sampData) {
                                sampData[s].Mark = false;
                            }
                        }
                    } else {
                        //We have something to search for so loop through all the data that we have and mark matches with a highlight flag.
                        var searchPattern = new RegExp(txt, "i");
                        for (var p in allData) {
                            var sampData = allData[p];
                            for (var s in sampData) {
                                if (searchPattern.test(sampData[s].column_name)) {
                                    sampData[s].Mark = true;
                                } else {
                                    sampData[s].Mark = false;
                                }
                            }

                        }
                    }

                },
                graph_type : "bar",

                //Changes the graph type that should be displayed on the canvas.  There may be a quicker
                //way to do this with jQuery, but this is good enough for now.
                // changeCanvasGraphType : function() {
                    // var types = document.getElementById("DC_026887848_canvas_graph_type");
                    // for ( i = 0; i < types.length; i++) {
                        // if (types.options[i].selected) {
                            // this.graph_type = types.options[i].value;
                            // break;
                        // }
                    // }
                    // //Now update the graph.
                    // this.updateCanvasGraph();
                // },

                updateCanvasGraph : function() {
                    if (DC_026887848.dsCanvas == true) {
                        var allData = this.probeData;
                        var ctx = this.getCanvas();
                        if (allData == null || ctx == null) {
                            return false;
                        }

                        if (this.graph_type == "bar" || this.graph_type == "plot") {
                            var ps = this.getCurrentProbeSet();
                            var data = null;
                            for (var pID in allData) {
                                if (ps == pID) {
                                    data = allData[pID];
                                }
                            }

                            if (data == null) {
                                return false;
                            }

                            // Adjust zoom values based on slider
                            var slider = $("#DC_026887848_canvas_chart_slider");
                            var sldValueMin = slider.slider("values", 0) / DC_026887848.sliderResolution;
                            //divide by the resolution to Get a percentage.
                            var sldValueMax = slider.slider("values", 1) / DC_026887848.sliderResolution;
                            data.zoomMaxVal = data.roundedMaxVal - ((data.roundedMaxVal - data.roundedMinVal) * (1 - sldValueMax));
                            data.zoomMinVal = data.roundedMinVal + ((data.roundedMaxVal - data.roundedMinVal) * (sldValueMin));

                            //Actually update the canvas now.
                            if (this.graph_type == "bar") {
                                var dataMap = DCCG.renderChartTall(ctx, data, "bar");
                                this.setCanvasMouseMap(dataMap);
                            } else if (this.graph_type == "plot") {
                                var dataMap = DCCG.renderChartTall(ctx, data, "plot");
                                this.setCanvasMouseMap(dataMap);
                            }
                        } else {
                            return false;
                        }
                    }
                },

                canvas_check : 0,
                checkForCanvas : function() {
                    if (this.canvas_check == 1) {
                        return true;
                    }

                    if (this.canvas_check == -1) {
                        $("#DC_026887848_canvas_error_message").show();
                        return false;
                    }

                    var ctx;
                    var cantest = document.createElement("canvas");

                    if ( typeof (DCCG) == "undefined" || !cantest || !cantest.getContext) {
                        if (!document.all) {//check for ie
                            $("#DC_026887848_canvas_error_message").show();
                        }

                        this.canvas_check = -1;
                        return false;
                    }

                    var ctx = cantest.getContext("2d");
                    if (!ctx || !ctx.fillText) {
                        if (!document.all) {//check for ie
                            $("#DC_026887848_canvas_error_message").show();
                        }

                        this.canvas_check = -1;
                        return false;
                    }

                    this.canvas_check = 1;
                    return true;
                },

                //
                //END CANVAS GRAPHING ROUTINES
                //
                //

                loadDataset : function(dsID) {
                    if (this.dsID == dsID) {
                        // Same dataset ID, do nothing
                        return;
                    } else {
                        DC_026887848.clearCorrData();
                        //ds is null, will initial ds and gene id
                        if (!dsID)
                        {
                            //1st try url
                            dsID = this._getUrlParam('dataset');
                            // then cookie
                            if (dsID == null)
                            {
                                var org_cookie_name = "org_10116";
                                var allcookies = document.cookie;
                                var cpos = allcookies.indexOf(org_cookie_name + "=");
                                if (cpos > -1) {
                                    var start = allcookies.indexOf("=", cpos) + 1;
                                    var end = allcookies.indexOf(";", start);
                                    if (end == -1) {
                                        end = allcookies.length;
                                    }
                                    dsID = decodeURIComponent(allcookies.substring(start, end));
                                }
                            }
                            // finally, server end default
                            geneID = this._getUrlParam('gene');
                            var prox_url;
                            if (geneID != null){
                                prox_url = "/dataset/default/?gene="+geneID;
                            }
                            else{
                                prox_url = "/dataset/default/";
                            }
                            $.getJSON(prox_url, function(dataJson, code) {
                                if (code != "success") {
                                    DCCG.buildCanvasError(DC_026887848.getCanvas());
                                } else {
                                    if (dataJson.code != 0)
                                    {
                                        DCCG.buildCanvasError(DC_026887848.getCanvas());
                                    }
                                    else
                                    {
                                        DC_026887848.geneID = dataJson.details.gene;
                                        DC_026887848.dsID = dataJson.details.dataset;
                                        if (dsID)
                                            DC_026887848.dsID = dsID;
                                        DC_026887848.setDatasetCookie();
                                        DC_026887848.loadFactors();
                                        DC_026887848.loadProbes();
                                    }
                                }
                            });
                        }
                        else
                        {//dataset changed
                            this.dsID = dsID;
                            this.setDatasetCookie();
                            DC_026887848.loadFactors();
                            this.loadProbes();
                        }
                    }
                },
                changeLabel : function(obj){
                    var label = $(obj).find('option:selected').attr('id');
//                    $(obj).find('option').css('background-color','');
//                    $(obj).find('option:selected').css('background-color','lightgray');
                    if(label=='Sample Name') this.chart_label = null;
                    else this.chart_label = label;
                    this.probeData = null;
                    $('.ui-icon-closethick').click();
                    this.setCanvasMouseMap(null);
                    this.getProbeData();
                },
                changeFacet : function(obj, rest){
                    var facet = $('#facter-list input:checked').attr('facet');
                    var group = $('#facter-list input:checked').parents('tr').
                        find('input:checkbox').attr('checked');
                    if(rest==null && facet){
                        this.facet = facet;
                        this.group = group;
                        if(group==true)
                        {
                            $('#label_toggle').hide();
                        }
                        else
                        {
                            if($('#label_names').find('option').length>0)
                            {
                                $('#label_toggle').show();
                            }
                        }
                    }
                    else{
                        this.facet = null;
                        this.group = false;
                        if($('#label_names').find('option').length>0)
                        {
                            $('#label_toggle').show();
                        }
                    }

                    this.chart_label = this.facet;
                    if($('#label_toggle').is(":visible"))
                    {
                        $('#label_names option').css('background-color', '');
                        if(this.facet)
                        {
                            $('#label_names option').each(function(i, e){
                                if($(e).attr('id')==DC_026887848.facet)
                                {
                                    $(e).css('background-color', 'lightgray');
                                    $(e).css('font-weight', 'bold');
                                    $(e).attr('selected', true);
                                }
                            });
                        }
                        else
                        {
                            $('#label_names option').eq(0).css('background-color', 'lightgray');
                            $('#label_names option').eq(0).attr('selected', true);
                        }
                    }
                    this.probeData = null;
                    // $('.ui-icon-closethick').click();
                    this.setCanvasMouseMap(null);
                    this.getProbeData();
                },
                clearLabel : function(){
                    $('#label_toggle').hide();
                    this.chart_label = null;
                    $('#label_names').find('option').remove();
                    $('#label_names').append('<option id="Sample Name">Sample Name</option>');
                },
                clearFacet : function(){
                    this._factor_dialog = '';
                    this.group = false;
                    this.facet = null;
                    $('#datasetFactors').hide();
                    $('#label_toggle').hide();
                },
                _clear_factor_select : function (obj){
                    $(obj).parents('tr').siblings().find('input:checkbox').attr('checked', false);
                    $(obj).parents('tr').siblings().find('input:checkbox').attr('disabled', 'disabled');
                    $(obj).parents('tr').find('input:checkbox').attr('disabled', false);
                },
                _clear_factor_radio : function () {
                    $('.factor-item').find('input:radio').attr('checked', false);
                },
                loadFactors : function(){
                    function getJsonObjLength(jsonObj) {
                        var Length = 0;
                        for (var item in jsonObj) {
                            Length++;
                        }
                        return Length;
                    }
                    //get factors
                    $.getJSON('/dataset/factors/'+this.dsID+'/', function(dataJson, code) {
                        if (code != "success") {
                            //DCCG.buildCanvasError(DC_026887848.getCanvas());
                        } else {
                            if (dataJson.code != 0)
                            {
                                //DCCG.buildCanvasError(DC_026887848.getCanvas());
                            }
                            else
                            {
                                var l= getJsonObjLength(dataJson.details);
                                var table='<div style="margin-bottom:5px">';
                                var sample_link = 'http://www.ebi.ac.uk/arrayexpress/experiments/'+DC_026887848.dsID+'/samples/';
                                var samples = '<a style="text-decoration: none; color: blue" href="'+sample_link+'">(more details)</a>';
                                if(l<=1) table += 'Pick the factor '+samples+' below, ';
                                else table += 'Pick one of '+l+' factors '+samples+' below, ';
                                table += 'and click "Apply":</div>';
                                table += '<div style="max-height:350px"><table style="width:100%"><thead><tr style="background: url(css/images/ui-bg_highlight-hard_75_9497b8_1x100.png) 50% 50% repeat-x;\
                                       font-size: 15px;line-height: 25px;font-size: 15px;"><th style="width: 20%; padding-left: 4px">Factor name</th><th style="width: 70%; padding-left: 4px">Factor values</th><th style="width: 10%; padding-left: 4px;padding-right: 4px;">\
                                       Collapse?</th></tr></thead><tbody>';
                                // var max_option = 5;
                                var bg;
                                var k=0;

                                //construct factor dialog
                                for(var f in dataJson.details)
                                {
                                    if(dataJson.details.hasOwnProperty(f)==false)
                                        continue;
                                    var options = dataJson.details[f].length;
                                    if(k%2 == 0) bg = '#eee'; else bg = '#ddd';
                                    k++;
                                    table += '<tr class="factor-item" style="background:'+bg+'"><td style="padding:2px">';
                                    table += '<input type="radio" name="factor" style="vertical-align: text-bottom" facet="'+f+'" onclick="DC_026887848._clear_factor_select(this)">';
                                    table += '<span style="margin-left:3px">'+f+'</span></td><td style="padding:2px; line-height: 22px; word-break: break-all;">';
                                    var opt_span = '<span style="border-radius: 3px; background-color: darkgray;padding: 2px 5px; margin: 2px">';
                                    for(var i=0; i<options; i++)
                                    {
                                        table += (opt_span+dataJson.details[f][i]+'</span>');
                                    }
                                    table += '</td><td style="padding:2px; text-align:center">';
                                    table += '<input id="group_check" type="checkbox" disabled="disabled">';
                                    table += '</td></tr>';
                                }

                                table += '</tbody></table></div>';
                                _factor_dialog = $('<div id="facter-list" style="font-size: 12px">'+table);
                                //show 'Show Factors' dialog
                                $('#datasetFactors').show();

                                //label toggle
                                var i = 0;
                                for(var f in dataJson.details)
                                {
                                    if(dataJson.details.hasOwnProperty(f)==false)
                                        continue;
                                    var shorten = f;
                                    if (f.length>12)
                                        shorten = f.substring(0,12)+'...';
                                    if(i=0){
                                        $('#label_names').append('<option id="'+f+'" style="background-color:lightgray">'+shorten+'</option>');
                                    }else{
                                        $('#label_names').append('<option id="'+f+'">'+shorten+'</option>');
                                    }
                                }
                                if($('#label_names').find('option').length>0)
                                {
                                    $('#label_toggle').show();
                                }
                            }
                        }
                    });
                },
                loadProbes : function() {
                    // Clear out old probe data, get new
                    this.clearProbeData();
                    this.getProbeData();
                    // set link to this dataset and gene page
                    var _url = window.location.href.split('?')[0]+
                        '?dataset='+this.dsID+'&gene='+this.geneID;
                    $('#link-content').val(_url);
                },
                loadTabs : function() {
                    if (this.checkForCanvas()) {
                        DC_026887848.dsCanvas = true;
                    }
                    $('#dataChartTabPanel').tabs({show: function (event, ui) {
                        if(ui.index == 0){
                            if (DC_026887848.dsCanvas == true) {
                                DC_026887848.updateCanvasGraph();
//                                setTimeout("DC_026887848.updateCanvasGraph();", 500);
                            }
                        }
                    }});

                    DC_026887848.updateCanvasGraph();
                },

                _getUrlParam : function (name)
                {
                    var reg = new RegExp("(^|&)"+ name +"=([^&]*)(&|$)");
                    var r = window.location.search.substr(1).match(reg);
                    if (r!=null) return unescape(r[2]); return null;
                },

                Corr_Grid : null, //use to store the correlation data.
                Corr_Store : null,
                loadToBioGPS : function() {
                    //biogps.utils.loadGeneList([1,2,3]);
                    var geneList = [];
                    if (DC_026887848.Corr_Store === null) {
                        alert("Nothing to load!");
                        return null;
                    }

                    var data;
                    if (DC_026887848.Corr_Store.allData != null) {
                        data = DC_026887848.Corr_Store.allData.items;
                    } else {
                        data = DC_026887848.Corr_Store.data.items;
                    }

                    if (data.length == 0) {
                        alert("Nothing to load!");
                        return null;
                    }

                    for ( i = 0; i < data.length; i++) {
                        geneList[i] = data[i].data.matched_term;
                    }

                    biogps.utils.loadGeneList(geneList);
                    return null;
                },

                getCurrentProbeSet : function() {
                    var probesets = document.getElementById("DC_026887848_probe");
                    var ps = "-1";
                    for ( i = 0; i < probesets.length; i++) {
                        if (probesets.options[i].selected) {
                            ps = probesets.options[i].text;
                        }
                    }
                    return ps;
                },

                buildCorrURL : function() {
                    var corrUrl = "/dataset/correlation/";
                    var corrVal = document.getElementById("DC_026887848_cor_val");
                    var corrFactor = parseFloat(corrVal.value);
                    if (corrFactor == "NaN") {
                        corrFactor = 0.9;
                        corrVal.value = 0.9;
                    } else {
                        corrVal.value = corrFactor;
                    }

                    if (corrFactor < 0.5) {
                        corrFactor = 0.5;
                        corrVal.value = 0.5;
                    }

                    if (corrFactor > 1.0) {
                        corrFactor = 1.0;
                        corrVal.value = 1.0;
                    }

                    var ds = this.dsID;
                    var probesets = document.getElementById("DC_026887848_probe");
                    var ps = "-1";
                    for ( i = 0; i < probesets.length; i++) {
                        if (probesets.options[i].selected) {
                            ps = probesets.options[i].text;
                        }
                    }

                    corrUrl = corrUrl + ds + "/reporter/" + ps + "/min/" + corrFactor+'/';
                    return corrUrl;
                },

                DLCorr : function() {
                    var corrUrl = DC_026887848.buildCorrURL();
                    corrUrl = corrUrl + "?type=csv";
                    window.open(corrUrl);
                },

                pageLink : function(){
                    $('#link-content').select();
                    $('#link-content').focus();
                    $('#copy-hint').show();
                },

                loadCorr : function() {
                    // create the Data Store for the correlation data
                    var corrUrl = this.buildCorrURL();
//                    start : 0,
//                    limit : 20
                    $('#DC_026887848_corr-grid').flexigrid({
                        url : corrUrl + "?start=0&limit=20",
                        method: 'GET',
                        errormsg: 'something wrong',
                        dataType : 'json',
                        striped: true,
                        colModel : [ {
                            display : 'Correlation',
                            name : 'value',
                            width : 80,
                            sortable : true,
                            align : 'center'
                        }, {
                            display : 'ID',
                            name : 'id',
                            width : 60,
                            sortable : true,
                            align : 'center'
                        }, {
                            display : 'Gene_Symbol',
                            name : 'symbol',
                            width : 100,
                            sortable : true,
                            align : 'center'
                        }, {
                            display : 'Probe',
                            name : 'reporter',
                            width : 100,
                            sortable : true,
                            align : 'center'
                        } ],
                        buttons : [ {
                            name : 'Download Correlation',
                            bclass : 'download',
                            onpress : this.DLCorr
                        } ],
                        width : 388,
                        height : 520,
                        usepager : true,
                        rp: 20,
                        useRp: false,
                        procmsg: 'Loading',
                        pagestat: '{from}-{to} of {total}'
                    });
/*
                    Ext.Ajax.timeout = 300000;
                    //increase default timeout to 5min
                    if (this.Corr_Store === null) {
                        var geneRec = Ext.data.Record.create(["id", "symbol", "value", "reporter"]);

                        this.Corr_Store = new Ext.ux.data.PagingStore({
                            url : corrUrl,
                            reader : new Ext.data.JsonReader({
                                // records will have a "gene" tag
                                id : "reporter"
                            }, geneRec)
                        });

                        // create the grid
                        this.Corr_Grid = new Ext.grid.GridPanel({
                            store : this.Corr_Store,
                            columns : [{
                                header : "Correlation",
                                width : 80,
                                dataIndex : "value",
                                sortable : true
                            }, {
                                header : "ID",
                                width : 60,
                                dataIndex : "id",
                                sortable : true
                            }, {
                                header : "Gene_Symbol",
                                width : 100,
                                dataIndex : "symbol",
                                sortable : true
                            }, {
                                header : "Probe",
                                width : 100,
                                dataIndex : "reporter",
                                sortable : true
                            }],
                            renderTo : "DC_026887848_corr-grid",
                            width : 360,
                            height : 520,
                            loadMask : true,
                            tbar : [{
                                text : 'Download Correlation',
                                tooltip : 'Downloads the correlation result as a .csv file',
                                handler : this.DLCorr,
                                iconCls : 'icon-load'
                            }],
                            bbar : new Ext.PagingToolbar({
                                pageSize : 20,
                                store : this.Corr_Store,
                                displayInfo : true,
                                displayMsg : "{0}-{1} of {2}",
                                emptyMsg : "No Genes to display",
                                items : ["-"]
                            })
                        });
                        this.Corr_Grid.render();

                        var opt = {
                            params : {
                                start : 0,
                                limit : 20
                            }
                        };
                        this.Corr_Store.load(opt);
                    } else {
                        var opt = {
                            params : {
                                start : 0,
                                limit : 20
                            }
                        };
                        delete this.Corr_Store.lastParams;
                        this.Corr_Store.proxy.conn.url = corrUrl;
                        this.Corr_Store.reload(opt);
                        this.Corr_Grid.render();
                    }
                    Ext.Ajax.timeout = 30000; */
                    //reset timeout to default 30s
                },
                isDatasetIamgeSamll : false,
                trailFresh : function(){
                    if (this.fresh_timer!=null){
                        clearTimeout(this.fresh_timer);
                    }
                    this.fresh_timer = setTimeout(
                        "DC_026887848.updateCanvasGraph();\
                        var w = $('#DC_026887848_dataset_image').width(); \
                        if(w>1200){ w=1200; DC_026887848.isDatasetIamgeSamll = false}\
                        else {DC_026887848.isDatasetIamgeSamll = true;}\
                        $('#DC_026887848_probe_set_image').width(w);\
                        DC_026887848.zoomImage();\
                        DC_026887848.fresh_timer=null;",
                        500);
                },
                checkDatasetImageSize: function () {
                    var w = $('#DC_026887848_dataset_image').width();
                    if(w < 1200){
                        DC_026887848.isDatasetIamgeSamll = true;
                        DC_026887848.zoomImage();
                    }
                },
                zoomImage : function () {
                    if(DC_026887848.isDatasetIamgeSamll){
                        $('#DC_026887848_probe_set_image').css('cursor', '-webkit-zoom-in');
                        $('#DC_026887848_probe_set_image').unbind('click');
                        $('#DC_026887848_probe_set_image').click(function () {
                            if($(this).css('width') == 'auto'){
                                $(this).css('width', '100%');
                                $(this).css('cursor', '-webkit-zoom-in');
                                $('#DC_026887848_dataset_image').css('overflow', 'scroll');
                            } else {
                                $(this).css('width', 'auto');
                                $(this).css('cursor', '-webkit-zoom-out');
                                $('#DC_026887848_dataset_image').css('overflow', 'scroll');
                            }
                            return false;
                        });
                    }else{
                        $('#DC_026887848_probe_set_image').css('cursor', 'auto');
                    }
                }
            };
        </script>

        <script type="text/javaScript" src="./js/data_chart_canvas.js"></script>
        <script language="JavaScript">
            var searchBar = $("<center><div id=\"searchBar\" style=\"font-size: 12px\">\
            <b>Search: </b><input type=\"text\" id=\"searchDS\" size=\"50\" onkeypress=\"DC_026887848.changeSearchTerm(event, this.value)\">\
            <div class=\"span-reset-search\" style=\"background-image: url(css/images/remove.png);width: 12px;height: 12px;display: inline-block;margin-bottom: -2px;margin-left: -18px;cursor: pointer\" onclick=\"DC_026887848.resetDSLib()\"></div>\
            <div id=\"dialog\"></div>\
            </div></center>\
            ");

            // Bind handler to retain search input focus, fire search
            //$(document).delegate("#searchDS", "keyup", function(event) {
            //  event.preventDefault();
            //  event.stopPropagation();
            //  $("#searchDS").focus();
            //});

            var _dialog = $("<div id=\"accordion\" style=\"font-size: 12px\">\
            <h3><a href=\"#\"><b>Default Datasets</b> (<span id=\"dsDefaultTotal\">0</span>)</a></h3>\
            <div id=\"dsDefaults\">\
            <ul id=\"dsDefaultsList\"></ul>\
            </div>\
            <h3><a href=\"#\"><b>Dataset Library</b> (<span id=\"dsLibTotal\">0</span>)</a></h3>\
            <div>\
            <ul id=\"dsList\"></ul>\
            <hr />\
            <span id=\"dialogBottomNav\">\
            <center>\
            <span id=\"pagingNav\">\
            <span id=\"prevPage\" style=\"width:15px\">\
            <a class=\"ds-dialog-nav\" href=\"javascript:void(0)\" onclick=\"DC_026887848.changeDSPage('-')\">\u00ab&nbsp;Prev</a></span>&nbsp;&nbsp;&nbsp;<span id=\"nextPage\" style=\"width:15px\"><a class=\"ds-dialog-nav\" href=\"javascript:void(0)\" onclick=\"DC_026887848.changeDSPage('+')\">Next&nbsp;\u00bb</a>\
            </span>\
            </span>\
            <span style=\"float: right\" id=\"dsLibPageText\">Page <span id=\"dsLibPageNum\"></span> of <span id=\"dsLibPages\"></span></span>\
            </center>\
            </span>\
            </div>\
            </div>").accordion({active: 1, autoHeight: false, icons: false});

            //factor dialog will be initialized when ds loaded;
            var _factor_dialog = "";

            // Bind handler to close dialog once ds is selected
            $(document).delegate(".ds-dialog", "click", function(event) {
                $(this).closest(".ui-dialog-content").dialog("destroy");
            });

            $(document).ready(function() {
                DC_026887848.init();
                // var link = $("<link>");
                // link.attr({
                    // type: "text/css",
                    // rel: "stylesheet",
                    // href: "./css/jquery-ui-1.8.5.custom.css"
                // });
                // $("head").append( link );
                // //$.getScript("/data_chart/assets/data_chart_canvas.js?ver=3", function() {
                // $.getScript("js/jquery-ui.js",function() {
                    // DC_026887848.init();
                // });
                // //});
            });
        </script>

    </head>
    <body onresize="DC_026887848.resizeCanvas(); DC_026887848.trailFresh();" class="   ext-webkit ext-chrome ext-linux">
        <div id="DC_026887848_outside" style="margin:5px">
            <div id="DC_026887848_top_input" style="margin:5px">
                <form method="get" action="./Data Chart Plugin_files/Data Chart Plugin.html" enctype="multipart/form-data" name="form1">
                    <div style="float:left"></div>
                </form>
                <div id="datasetNameContainer" style="width:99%">
                    <div style="float: left;width: 80%;">
                        <b>Dataset: </b><span id="datasetName"><a class="ds-name" href="http://biogps.org/dataset/5" target="_blank"></a></span>
                        <span id="go-ae" style='display: none'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="go-ae btn-use-object requires-js" href="http://www.ebi.ac.uk/">[source]</a></span>
                    </div>
                    <div style="float: right; display: inline; width: 20%">
                        <input type="button" id="change-dataset" value="Change Dataset" style="padding-left:10px; padding-right:10px; float: right; width:120px; height:40px; font-size: 14px;"
                             onclick="DC_026887848.changeDataset()">
                    </div>
                </div>
                <div style='width: 99%; display:block'>
                    <div id="datasetProbes" style="float:left;">
                        <b>Probeset:</b>
                        <select id="DC_026887848_probe" onchange="DC_026887848.setProbe(); DC_026887848.clearCorrData()">

                            <option>D28753_i_at</option><option>D28754_s_at</option>
                        </select>
                    </div>
                    <div id="datasetFactors" style="float:left; padding-left:10px; display:none">
                        <input type="button" id="show-factors" value="Show Factors" style="padding-left:10px; padding-right:10px; float: left;"
                             onclick="DC_026887848.showFactors()">
                    </div>
                </div>
                <div id="datasetSummaryContainer" style="width: 99%; float:left">
                    <b>Summary: </b><span id="datasetSummary"></span>&nbsp;<a id="datasetSummaryMoreLink" class="requires-js" href="javascript:void(0)" onclick="DC_026887848.updateSummary(&quot;more&quot;);" style="display: none;">more</a>
                </div>
                <div id="datasetLinkContainer" style="width: 99%; float:left; margin-bottom: 3px;">
                    <b>Link: </b>&nbsp;
                    <a href="javascript:void(0)" title="permanent link of the current chart">
                        <input id="link-content" type="text" readonly="readonly" style="width: 100px; color: gray; border: 1px inset;"
                        onclick="if($('#link-content').width()>100){$('#link-content').css('width','100px');} else $('#link-content').css('width','500px');"
                        onblur="$('#copy-hint').hide();"></a>
                    <a href="javascript:var _url=DC_026887848.pageLink();" style="text-decoration:none;" title="get permanent link of the current chart">
                        <img src="images/default/button/link.png" style="width: 15px;height: 15px; margin-bottom: -3px">
                    </a>
                    <span style='display:none; font-size: small; font-style: italic; color: gray;' id='copy-hint'>press ctrl+c to copy</span>
                </div>
                <div id="datasetSourceContainer" style="display: none; width: 99%;">
                    <b>Source: </b><span id="datasetSource"></span>
                </div>
            </div>
            <div id="DC_026887848_tabs1" style="clear: both; margin: 5px;">
                <div id="dataChartTabPanel" class=" x-tab-panel" style="width: 1168px;">
                    <ul style="border-bottom: 1px solid #8db2e3;padding-bottom: 1px;">
                        <li><a href="#DC_026887848_dataset_canvas">Interactive Image</a></li>
                        <li><a href="#DC_026887848_dataset_image">Static Image</a></li>
                        <li><a href="#DC_026887848_correlation">Correlation</a></li>
                        <li><a href="#DC_026887848_Download">Downloads</a></li>
                    </ul>
                    <div id="DC_026887848_dataset_canvas" class="">
                        <div style="font: normal normal normal 11px/normal tahoma, arial, helvetica, sans-serif;">
                            <div style="float:left; width:100%; display: block; position: relative; margin-top:5px">
                                <div style="position:relative; float:left; left: 100%; margin-left: -99%; width:98%">
                                    <p id="DC_026887848_canvas_error_message" class="\&quot;ds-error\&quot;" style="display:none; text-align:left">
                                        Your browser does not support HTML5 features required for the interactive gene expression chart. Please use the Static Image or update to the latest version of your browser.
                                    </p>
                                </div>
                            </div>
                            <div style="float:left; width:100%; display: block; position: relative; margin-top:5px">
                                <div style="position:relative; float:left; left: 100%; margin-left: -99%; width:25%">
                                    <p id="DC_026887848_canvas_search_controls" style="text-align: left;">
                                        Search:
                                        <input style="font-size: 10px; width:50%;" type="text" id="DC_026887848_canvas_search" size="8" onkeyup="DC_026887848.searchGraph()">
                                    </p>
                                </div>
                                <div id='label_toggle' style="position:relative; float:left; left: 100%; margin-left: -74%; width:25%; display:none">
                                    <p id="DC_026887848_canvas_label_choice" style="text-align: left;">
                                        Label:
                                        <select id='label_names' onchange='DC_026887848.changeLabel(this)'><option id='Sample Name'>Sample Name</option></select>
                                    </p>
                                </div>
                                <div style="position:relative; float:left; left: 100%; margin-left: -50%; width:10%; margin-top:3px">
                                    <p id="DC_026887848_canvas_zoom_label" style="text-align: right; margin-right: 8px;">
                                        Zoom:
                                    </p>
                                </div>
                                <div style="position:relative; float:left; left: 100%; margin-left: -40%; width:38%; margin-top:5px">
                                    <div id="DC_026887848_canvas_chart_slider" class="ui-slider ui-slider-horizontal ui-widget ui-widget-content ui-corner-all">
                                        <div class="ui-slider-range ui-widget-header" style="left: 0%; width: 100%;"></div><a href="http://plugins.biogps.org/data_chart/data_chart.cgi?id=362817#" class="ui-slider-handle ui-state-default ui-corner-all" style="left: 0%;"></a><a href="http://plugins.biogps.org/data_chart/data_chart.cgi?id=362817#" class="ui-slider-handle ui-state-default ui-corner-all" style="left: 100%;"></a>
                                    </div>
                                </div>
                            </div>
                            <div style="float:left; width:100%; display: block; position: relative;">
                                <div style="position:relative; float:left; left: 100%; margin-left: -99%; width:99%">
                                    <canvas id="DC_026887848_canvas_chart" height="511" width="1168">
                                        <iframe frameborder="0" style="border: 1px solid #AAAAAA;" width="370" height="370" src="./browsers.html">
                                            &lt;p&gt;Your browser does not support iframes or the canvas object.  You might consider upgrading to a modern browser.&lt;/p&gt;
                                        </iframe>
                                    </canvas>
                                </div>
                            </div>
                            <div style="float:left; width:100%; display: block; position: relative;">
                                <div style="position:relative; float:left; left: 100%; margin-left: -99%; width:20%">
                                    <input style="" type="button" id="DC_026887848_canvas_save_button" value="Save Image" onclick="DC_026887848.saveCanvas()">
                                </div>
                                <!-- <div style="position:relative; float:left; left: 100%; margin-left: -75%; width:30%">
                                    <p style="" id="DC_026887848_canvas_graph_type_wrapper">
                                        Chart Type:
                                        <select style="font-size: 10px;" id="DC_026887848_canvas_graph_type" onchange="DC_026887848.changeCanvasGraphType()">
                                            <option value="bar">Bar</option>
                                            <option value="plot">Plot</option>
                                        </select>
                                    </p>
                                </div> -->
                                <div style="position:relative; float:left; left: 100%; margin-left: -25%; width:25%; text-align:right;">
                                    <input style="" type="button" id="DC_026887848_canvas_clear_button" value="Clear Labels" onclick="DC_026887848.clearCanvasLabels()">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="DC_026887848_dataset_image" class="">
                        <img id="DC_026887848_probe_set_image" title="Data Chart Image" alt="Data Chart Image" src="">
                    </div>
                    <div id="DC_026887848_correlation" class="">
                        <span id="DC_026887848_correlationContainer">
                            <p style="margin:5px;font-size: 2em;">
                                Correlation Cutoff:
                                <input type="text" id="DC_026887848_cor_val" size="5" value="0.9">
                                <input type="button" id="DC_026887848_cor_button&quot;" value="Go!" onclick="DC_026887848.loadCorr()">
                            </p> <div id="DC_026887848_corr-grid" style="margin:5px; margin-left: 0px;"></div>
                        </span>
                    </div>
                    <div id="DC_026887848_Download" class="">
                    <span id="DC_026887848_downloadContainer">
                        <p style="margin:5px">
                            <a id="DC_026887848_Download_link" href="javascript:void(0)" style="font-size: 2em;color: -webkit-link;"></a>
                        </p> </span>
                    </div>
                </div>


                </div>
            </div>
            <p style="font-size: 8pt">
                <a href="mailto:biogps@googlegroups.com">Can't see the expression image?  Please let us know!</a>
            </p>
            <p id="datachartVer" style="font-size: 7pt">
                Version 2.0
            </p>
        </div>

    </body>
</html>
